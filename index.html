<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Staf - Payboss Cafe</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }

        /* Login Page */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .login-container h1 {
            color: #3E2723;
            margin-bottom: 20px;
        }
        .login-container .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .login-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .login-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .login-container button {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: none;
            background: #8B4513;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .login-container button:hover {
            background: #A0522D;
        }
        #login-error {
            color: #D32F2F;
            margin-top: 15px;
            font-weight: 500;
        }

        /* App Styles */
        html { height: 100%; }
        .nav-bar {
            background: rgba(62, 39, 35, 0.95); padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center; position: sticky;
            top: 0; z-index: 1000; backdrop-filter: blur(10px);
        }
        .nav-brand { color: #D2B48C; font-size: 1.5rem; font-weight: bold; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link, #logout-btn {
            color: #D2B48C; text-decoration: none; padding: 8px 16px; border-radius: 6px;
            transition: all 0.3s ease; font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active, #logout-btn:hover { background: #8B4513; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page {
            display: none; background: rgba(255, 255, 255, 0.95); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin-bottom: 20px;
        }
        .page.active { display: block; }
        .page-header {
            background: linear-gradient(135deg, #3E2723 0%, #5D4037 100%); color: white;
            padding: 30px; text-align: center;
        }
        .page-header h1 { margin: 0 0 10px 0; font-size: 2.5rem; font-weight: bold; }
        .page-header p { margin: 0; opacity: 0.9; font-size: 1.1rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 25px; }
        .stat-card {
            background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center; transition: transform 0.3s ease; position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #8B4513, #D2B48C);
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #3E2723; margin-bottom: 8px; }
        .stat-label { color: #666; font-size: 1.1rem; margin-bottom: 10px; }
        .order-list { background: white; border-radius: 15px; padding: 25px; margin: 0 25px 25px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-item { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #8B4513; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .order-id { font-weight: bold; font-size: 1.1rem; color: #3E2723; }
        .order-status { padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-preparing { background: #cce5ff; color: #004085; }
        .status-ready { background: #d4edda; color: #155724; }
        .order-details { font-size: 0.95rem; color: #666; line-height: 1.5; }
        .action-btn {
            background: #8B4513; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin: 5px;
            transition: background 0.3s ease;
        }
        .action-btn:hover { background: #A0522D; }
        .action-btn.success { background: #28a745; }
        .action-btn.success:hover { background: #218838; }
        
        /* [--- TAMBAHAN UNTUK CETAK ---] */
        .action-btn.print {
            background-color: #007bff;
        }
        .action-btn.print:hover {
            background-color: #0056b3;
        }
        /* [--- AKHIR TAMBAHAN ---] */

        .notification {
            position: fixed; top: 20px; right: 20px; background: #8B4513; color: white;
            padding: 15px 20px; border-radius: 8px; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: bold; transform: translateX(calc(100% + 30px)); transition: transform 0.4s ease-in-out;
        }
        .notification.show { transform: translateX(0); }
        .report-box { background: #fff; padding: 25px; border-radius: 15px; margin: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .report-box h3 { margin-top: 0; }
        .report-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .report-controls input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .report-controls button { padding: 12px 20px; }

        /* --- STYLE BARU UNTUK KELOLA MENU --- */
        .menu-item-manage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .menu-item-info {
            font-weight: bold;
            color: #3E2723;
        }
        .menu-item-info span {
            font-weight: normal;
            color: #666;
            font-size: 0.9rem;
            display: block;
        }
        .toggle-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
            width: 110px; /* Lebar tetap agar rapi */
            text-align: center;
        }
        .toggle-btn.available {
            background: #28a745; /* Hijau */
            color: white;
        }
        .toggle-btn.unavailable {
            background: #dc3545; /* Merah */
            color: white;
        }
        .toggle-btn:hover {
            opacity: 0.8;
        }
        .menu-category-header {
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.3rem;
            color: #3E2723;
            border-bottom: 2px solid #D2B48C;
            padding-bottom: 5px;
        }
        /* --- AKHIR STYLE BARU --- */


        @media (max-width: 768px) {
            .login-container { padding: 25px; }
            .nav-bar { flex-direction: column; gap: 10px; }
            .nav-links { justify-content: center; flex-wrap: wrap; gap: 5px; }
            .container { padding: 10px; }
            .dashboard-grid, .order-list { padding: 15px; margin: 0 10px 15px 10px; }
            .page-header h1 { font-size: 2rem; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .order-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .report-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-container">
            <h1>‚òï Portal Staf</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
                <p id="login-error" class="hidden"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="nav-bar">
            <a href="#" class="nav-brand">‚òï Portal Staf Payboss</a>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-page="cashier">üí∞ Kasir</a>
                <a href="#" class="nav-link" data-page="kitchen">üë®‚Äçüç≥ Dapur</a>
                <!-- MENU BARU DITAMBAHKAN DISINI -->
                <a href="#" class="nav-link" data-page="menu">üçΩÔ∏è Kelola Menu</a>
                <a href="#" class="nav-link" data-page="manager">üìä Manager</a>
                <a href="#" id="logout-btn">Logout</a>
            </div>
        </nav>

        <div class="container">
            <div id="cashier-page" class="page active">
                <div class="page-header"><h1>üí∞ Sistem Kasir</h1><p>Kelola pesanan dan pembayaran pelanggan</p></div>
                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üõí</span><div class="stat-value" id="total-orders">0</div><div class="stat-label">Total Pesanan Aktif</div></div>
                    <div class="stat-card"><span class="stat-icon">üí∞</span><div class="stat-value" id="daily-revenue">Rp 0</div><div class="stat-label">Pendapatan Hari Ini</div></div>
                    <div class="stat-card"><span class="stat-icon">‚è±Ô∏è</span><div class="stat-value" id="pending-orders">0</div><div class="stat-label">Pesanan Menunggu</div></div>
                </div>
                <div class="order-list"><h3>üìã Daftar Pesanan</h3><div id="cashier-orders"></div></div>
            </div>
            <div id="kitchen-page" class="page">
                <div class="page-header"><h1>üë®‚Äçüç≥ Dashboard Dapur</h1><p>Kelola pesanan yang perlu dimasak</p></div>
                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üî•</span><div class="stat-value" id="cooking-orders">0</div><div class="stat-label">Sedang Dimasak</div></div>
                    <div class="stat-card"><span class="stat-icon">‚úÖ</span><div class="stat-value" id="ready-orders">0</div><div class="stat-label">Siap Disajikan</div></div>
                    <div class="stat-card"><span class="stat-icon">üçΩÔ∏è</span><div class="stat-value" id="completed-orders-kitchen">0</div><div class="stat-label">Pesanan Selesai Hari Ini</div></div>
                </div>
                <div class="order-list"><h3>üç≥ Antrian Pesanan</h3><div id="kitchen-orders"></div></div>
            </div>

            <!-- HALAMAN BARU UNTUK KELOLA MENU -->
            <div id="menu-page" class="page">
                <div class="page-header"><h1>üçΩÔ∏è Kelola Ketersediaan Menu</h1><p>Atur menu yang tersedia atau habis di aplikasi pelanggan</p></div>
                <div class="order-list">
                    <h3>Daftar Menu</h3>
                    <div id="menu-management-list">
                        <!-- Daftar menu akan dimuat oleh JavaScript di sini -->
                    </div>
                </div>
            </div>
            <!-- AKHIR HALAMAN BARU -->

            <div id="manager-page" class="page">
                <div class="page-header"><h1>üìä Dashboard Manager</h1><p>Analisis performa dan laporan bisnis</p></div>
                
                <div class="report-box">
                    <h3>Laporan Penjualan</h3>
                    <div class="report-controls">
                        <input type="date" id="start-date">
                        <input type="date" id="end-date">
                        <button id="download-report-btn" class="action-btn success">Download Laporan (Excel)</button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üí∞</span><div class="stat-value" id="manager-total-sales">Rp 0</div><div class="stat-label">Total Penjualan Hari Ini</div></div>
                    <div class="stat-card"><span class="stat-icon">üì¶</span><div class="stat-value" id="manager-total-orders">0</div><div class="stat-label">Total Transaksi Selesai</div></div>
                    <div class="stat-card"><span class="stat-icon">üìà</span><div class="stat-value" id="manager-avg-order">Rp 0</div><div class="stat-label">Rata-rata per Transaksi</div></div>
                </div>
                <div class="order-list"><h3>üìä Menu Terlaris Hari Ini</h3><div id="best-selling-list"><p>Belum ada data penjualan hari ini.</p></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
         apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
         authDomain: "payboss-cafe-system.firebaseapp.com",
         projectId: "payboss-cafe-system",
         storageBucket: "payboss-cafe-system.appspot.com",
         messagingSenderId: "570523503793",
         appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
         measurementId: "G-H1NJ369HE9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        let unsubscribeOrders = null;
        let unsubscribeCompleted = null;
        let unsubscribeMenu = null; // <-- Variabel baru untuk listener menu
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const managerEmails = ['fedrik.christian07@gmail.com'];
                const staffEmails = ['payboss.tanjung@gmail.com'];
                let userRole = null;

                if (managerEmails.includes(user.email)) userRole = 'manager';
                else if (staffEmails.includes(user.email)) userRole = 'staff';

                if (userRole) {
                    loginPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setupUIForRole(userRole);
                    initializeAppLogic();
                } else {
                    signOut(auth).then(() => sessionStorage.setItem('loginError', 'Akun Anda tidak memiliki hak akses.'));
                }
            } else {
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                const storedError = sessionStorage.getItem('loginError');
                if (storedError) {
                    loginError.textContent = storedError;
                    loginError.classList.remove('hidden');
                    sessionStorage.removeItem('loginError');
                }
                // Hentikan semua listener saat logout
                if (unsubscribeOrders) { unsubscribeOrders(); unsubscribeOrders = null; }
                if (unsubscribeCompleted) { unsubscribeCompleted(); unsubscribeCompleted = null; }
                if (unsubscribeMenu) { unsubscribeMenu(); unsubscribeMenu = null; } // <-- Hentikan listener menu
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    let message = "Email atau password salah.";
                    loginError.textContent = message;
                    loginError.classList.remove('hidden');
                });
        });

        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        function setupUIForRole(role) {
            const managerLink = document.querySelector('.nav-link[data-page="manager"]');
            if (role === 'manager') {
                managerLink.classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('start-date').value = today;
                document.getElementById('end-date').value = today;
            } else {
                managerLink.classList.add('hidden');
                if (document.getElementById('manager-page').classList.contains('active')) {
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById('cashier-page').classList.add('active');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelector('.nav-link[data-page="cashier"]').classList.add('active');
                }
            }
            // Tab "Kelola Menu" (data-page="menu") akan otomatis terlihat untuk semua role (staff & manager)
            // karena tidak kita sembunyikan secara spesifik.
        }

        function initializeAppLogic() {
            let activeOrders = [];
            let completedToday = [];

            if (!unsubscribeOrders) {
                unsubscribeOrders = onSnapshot(collection(db, 'orders'), (snapshot) => {
                    activeOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStaffOrders(activeOrders);
                    updateAllDashboards(activeOrders, completedToday);
                });
            }

            if (!unsubscribeCompleted) {
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                unsubscribeCompleted = onSnapshot(query(collection(db, "completedOrders"), where("completedAt", ">=", todayStart)), (snapshot) => {
                    completedToday = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAllDashboards(activeOrders, completedToday);
                });
            }

            // --- LISTENER BARU UNTUK MENU ---
            // PERBAIKAN: Mengganti 'menuItems' ke 'menu' agar sesuai dengan database Anda
            if (!unsubscribeMenu) {
                unsubscribeMenu = onSnapshot(collection(db, 'menu'), (snapshot) => {
                    const menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuManagement(menuItems);
                });
            }
            // --- AKHIR LISTENER BARU ---

            setupNavigation();
            setupOrderActionListeners();
            setupMenuActionListeners(); // <-- Panggil fungsi listener baru
            setupReportDownloader();
        }

        function renderStaffOrders(orders) {
            const cashierContainer = document.getElementById('cashier-orders');
            const kitchenContainer = document.getElementById('kitchen-orders');
            if(!cashierContainer || !kitchenContainer) return;
            const kitchenQueue = orders.filter(o => o.status === 'pending' || o.status === 'preparing');
            
            cashierContainer.innerHTML = orders.length > 0 ? '' : '<p>Belum ada pesanan aktif.</p>';
            orders.forEach(order => cashierContainer.appendChild(createOrderElement(order, 'cashier')));
            kitchenContainer.innerHTML = kitchenQueue.length > 0 ? '' : '<p>Tidak ada antrian di dapur.</p>';
            kitchenQueue.forEach(order => kitchenContainer.appendChild(createOrderElement(order, 'kitchen')));
        }
        
        function createOrderElement(order, type) {
            const div = document.createElement('div');
            div.className = 'order-item';
            const statusMap = {
                pending: { text: 'Menunggu', class: 'status-pending' },
                preparing: { text: 'Dimasak', class: 'status-preparing' },
                ready: { text: 'Siap', class: 'status-ready' }
            };
            let buttons = '';
            if (type === 'cashier') {
                if (order.status === 'pending') {
                    buttons = `<button class="action-btn" data-id="${order.id}" data-action="confirm">Konfirmasi</button>`;
                } else if (order.status === 'ready') {
                    buttons = `<button class="action-btn success" data-id="${order.id}" data-action="complete">Selesaikan</button>`;
                }
                // [--- TAMBAHAN UNTUK CETAK ---]
                // Selalu tambahkan tombol cetak untuk kasir, terlepas dari statusnya
                buttons += ` <button class="action-btn print" data-id="${order.id}" data-action="print">Cetak</button>`;
                // [--- AKHIR TAMBAHAN ---]

            } else if (type === 'kitchen') {
                if (order.status === 'pending') buttons = `<button class="action-btn" disabled>Tunggu Konfirmasi</button>`;
                if (order.status === 'preparing') buttons = `<button class="action-btn success" data-id="${order.id}" data-action="finish">Selesai Masak</button>`;
            }
            // MODIFIKASI: Tambahkan logika untuk menampilkan varian jika ada
            const items = order.items.map(i => 
                `${i.name}${i.variant ? ` (${i.variant})` : ''} x${i.qty}`
            ).join(', ');
            const time = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('id-ID') : '...';

            let detailsHtml;
            if (order.subtotal !== undefined && order.tax !== undefined) {
                   detailsHtml = `
                        <strong>Subtotal:</strong> Rp ${order.subtotal.toLocaleString('id-ID')}<br>
                        <strong>Pajak (10%):</strong> Rp ${order.tax.toLocaleString('id-ID')}<br>
                        <strong>Grand Total:</strong> Rp ${order.total.toLocaleString('id-ID')} | <strong>Waktu:</strong> ${time}
                    `;
            } else {
                detailsHtml = `<strong>Total:</strong> Rp ${order.total.toLocaleString('id-ID')} | <strong>Waktu:</strong> ${time}`;
            }

            div.innerHTML = `
                <div class="order-header">
                    <span class="order-id">Meja ${order.table} - ${order.customer}</span>
                    <span class="order-status ${statusMap[order.status].class}">${statusMap[order.status].text}</span>
                </div>
                <div class="order-details">
                    <strong>Pesanan:</strong> ${items}<br>
                    ${detailsHtml}
                </div>
                <div style="margin-top: 10px;">${buttons}</div>
            `;
            return div;
        }
        
        // --- FUNGSI BARU UNTUK RENDER KELOLA MENU ---
        function renderMenuManagement(menuItems) {
            const container = document.getElementById('menu-management-list');
            if (!container) return;
            
            // Urutkan berdasarkan kategori, lalu nama
            menuItems.sort((a, b) => {
                const categoryA = a.category || 'lainnya';
                const categoryB = b.category || 'lainnya';
                if (categoryA < categoryB) return -1;
                if (categoryA > categoryB) return 1;
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });

            container.innerHTML = menuItems.length > 0 ? '' : '<p>Belum ada item menu di database. Hubungi admin untuk menambahkan.</p>';
            
            let currentCategory = "";
            menuItems.forEach(item => {
                const itemCategory = item.category || 'lainnya';
                // Tambahkan header kategori jika berbeda
                if (itemCategory !== currentCategory) {
                    currentCategory = itemCategory;
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.className = 'menu-category-header';
                    categoryHeader.textContent = currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1);
                    container.appendChild(categoryHeader);
                }

                const div = document.createElement('div');
                div.className = 'menu-item-manage';
                
                // Cek status ketersediaan. Default 'true' (tersedia) jika field-nya tidak ada
                const isAvailable = item.isAvailable !== false; 
                const availabilityClass = isAvailable ? 'available' : 'unavailable';
                const availabilityText = isAvailable ? 'Tersedia' : 'Habis';

                div.innerHTML = `
                    <div class="menu-item-info">
                        ${item.name}
                        <span>Rp ${item.price.toLocaleString('id-ID')}</span>
                    </div>
                    <button class="toggle-btn ${availabilityClass}" 
                            data-id="${item.id}" 
                            data-action="toggle-availability" 
                            data-current-status="${isAvailable}"
                            data-name="${item.name}">
                        ${availabilityText}
                    </button>
                `;
                container.appendChild(div);
            });
        }
        // --- AKHIR FUNGSI BARU ---


        function updateAllDashboards(activeOrders, completedOrders) {
            const totalSales = completedOrders.reduce((sum, order) => sum + order.total, 0);
            const updateElementText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };
            
            updateElementText('total-orders', activeOrders.length);
            updateElementText('pending-orders', activeOrders.filter(o => o.status === 'pending').length);
            updateElementText('cooking-orders', activeOrders.filter(o => o.status === 'preparing').length);
            updateElementText('ready-orders', activeOrders.filter(o => o.status === 'ready').length);
            updateElementText('daily-revenue', `Rp ${totalSales.toLocaleString('id-ID')}`);
            updateElementText('completed-orders-kitchen', completedOrders.length);
            updateElementText('manager-total-sales', `Rp ${totalSales.toLocaleString('id-ID')}`);
            updateElementText('manager-total-orders', completedOrders.length);
            const avgOrder = completedOrders.length > 0 ? Math.round(totalSales / completedOrders.length) : 0;
            updateElementText('manager-avg-order', `Rp ${avgOrder.toLocaleString('id-ID')}`);
            updateBestSelling(completedOrders);
        }
        
        function updateBestSelling(completedOrders) {
             const container = document.getElementById('best-selling-list');
             if(!container) return;
             if (completedOrders.length === 0) {
                 container.innerHTML = '<p>Belum ada data penjualan hari ini.</p>';
                 return;
             }
             const sales = {};
             completedOrders.forEach(order => {
                 order.items.forEach(item => {
                     // MODIFIKASI: Gunakan nama + varian sebagai kunci unik
                     const itemName = `${item.name}${item.variant ? ` (${item.variant})` : ''}`;
                     if (!sales[itemName]) sales[itemName] = { qty: 0, revenue: 0 };
                     sales[itemName].qty += item.qty;
                     sales[itemName].revenue += (item.price * item.qty);
                 });
             });
             const sorted = Object.entries(sales).sort(([,a],[,b]) => b.qty - a.qty).slice(0, 3);
             const medals = ['ü•á', 'ü•à', 'ü•â'];
             container.innerHTML = sorted.map(([name, data], i) => `
                 <div class="order-item">
                     <div class="order-header"><span class="order-id">${medals[i]} ${name}</span><span class="order-status status-ready">${data.qty} porsi</span></div>
                     <div class="order-details">Pendapatan (sblm pajak): Rp ${data.revenue.toLocaleString('id-ID')}</div>
                 </div>
             `).join('');
        }
        
        function setupOrderActionListeners() {
            if (document.body.dataset.actionListenerAttached) return;
            document.body.dataset.actionListenerAttached = 'true';

            document.body.addEventListener('click', async function(e) {
                const actionBtn = e.target.closest('.action-btn[data-action]');
                if (!actionBtn) return;

                const orderId = actionBtn.dataset.id;
                const action = actionBtn.dataset.action;
                const orderRef = doc(db, 'orders', orderId);
                try {
                    if (action === 'confirm') await updateDoc(orderRef, { status: 'preparing' });
                    else if (action === 'finish') await updateDoc(orderRef, { status: 'ready' });
                    else if (action === 'complete') {
                        const orderDoc = await getDoc(orderRef);
                        if (orderDoc.exists()){
                            const orderData = orderDoc.data();
                            await addDoc(collection(db, 'completedOrders'), { ...orderData, completedAt: serverTimestamp() });
                            await deleteDoc(orderRef);
                            showNotification('Pesanan selesai.');
                        }
                    // [--- TAMBAHAN UNTUK CETAK ---]
                    } else if (action === 'print') {
                        // Saat tombol cetak diklik, ambil data terbaru dari pesanan itu
                        const orderToPrintDoc = await getDoc(orderRef);
                        if (orderToPrintDoc.exists()) {
                            const orderData = { id: orderToPrintDoc.id, ...orderToPrintDoc.data() };
                            // Panggil fungsi cetak baru
                            printReceipt(orderData);
                        } else {
                            // Cek juga di completedOrders, siapa tahu sudah selesai tapi mau dicetak ulang
                            const completedOrderRef = doc(db, 'completedOrders', orderId);
                            const completedOrderDoc = await getDoc(completedOrderRef);
                            if (completedOrderDoc.exists()) {
                                const orderData = { id: completedOrderDoc.id, ...completedOrderDoc.data() };
                                printReceipt(orderData);
                            } else {
                                showNotification("Data pesanan tidak ditemukan.", true);
                            }
                        }
                    }
                    // [--- AKHIR TAMBAHAN ---]
                } catch (error) { console.error(error); showNotification('Gagal memproses aksi!', true); }
            });
        }


        // [--- FUNGSI BARU UNTUK MEMBUAT STRUK DAN MENCETAK ---]
        function printReceipt(order) {
            // Helper function untuk padding teks agar rata kanan/kiri
            // 32 karakter adalah lebar standar untuk kertas thermal 58mm
            const receiptWidth = 32; 
            const pad = (str, len, char = ' ') => String(str).padEnd(len, char);
            const padLeft = (str, len, char = ' ') => String(str).padStart(len, char);
            
            let receiptText = '';

            // --- Header Struk ---
            receiptText += "   Payboss Cafe\n"; // Dibuat menjorok agar seperti di tengah
            receiptText += "--------------------------------\n";
            receiptText += `Meja: ${order.table}\n`;
            receiptText += `Pelanggan: ${order.customer}\n`;
            
            // Tentukan waktu cetak (jika sudah selesai, pakai completedAt, jika belum, pakai createdAt)
            const orderTime = order.completedAt?.seconds ? order.completedAt.seconds : (order.createdAt?.seconds || Date.now() / 1000);
            const time = new Date(orderTime * 1000);
            receiptText += `Waktu: ${time.toLocaleDateString('id-ID')} ${time.toLocaleTimeString('id-ID')}\n`;
            receiptText += "--------------------------------\n";

            // --- Daftar Item ---
            order.items.forEach(item => {
                // Baris 1: Nama Item (bisa 2 baris jika panjang)
                let itemName = `${item.qty}x ${item.name}${item.variant ? ` (${item.variant})` : ''}`;
                
                // Potong nama item jika terlalu panjang
                if (itemName.length > receiptWidth) {
                    receiptText += pad(itemName.substring(0, receiptWidth), receiptWidth) + "\n";
                    receiptText += pad("   " + itemName.substring(receiptWidth), receiptWidth) + "\n";
                } else {
                    receiptText += pad(itemName, receiptWidth) + "\n";
                }
                
                // Baris 2: Harga (rata kanan)
                const itemTotal = item.price * item.qty;
                receiptText += padLeft(`Rp ${itemTotal.toLocaleString('id-ID')}`, receiptWidth) + "\n";
            });
            receiptText += "--------------------------------\n";

            // --- Bagian Total ---
            // (18 karakter untuk label, 14 untuk nilai)
            if (order.subtotal !== undefined) {
                receiptText += pad("Subtotal", 18) + padLeft(`Rp ${order.subtotal.toLocaleString('id-ID')}`, 14) + "\n";
                receiptText += pad("Pajak (10%)", 18) + padLeft(`Rp ${order.tax.toLocaleString('id-ID')}`, 14) + "\n";
            }
            receiptText += pad("GRAND TOTAL", 18) + padLeft(`Rp ${order.total.toLocaleString('id-ID')}`, 14) + "\n";
            receiptText += "--------------------------------\n";
            receiptText += "\n";
            receiptText += "  Terima kasih atas kunjungan\n";
            receiptText += "           Anda!\n\n\n";

            // --- Logika untuk Mencetak ---
            // Kita buat iframe tersembunyi, isi dengan struk, lalu panggil print
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.left = '-9999px'; // Sembunyikan dari layar
            document.body.appendChild(iframe);

            const doc = iframe.contentWindow.document;
            doc.open();
            // Kita gunakan tag <pre> agar format teks (spasi, baris baru) terjaga
            doc.write(`
                <html>
                <head>
                    <title>Cetak Struk</title>
                    <style>
                        /* Paksa styling untuk printer thermal */
                        body { 
                            font-family: 'monospace'; /* Font yang lebarnya sama */
                            font-size: 10pt; 
                            margin: 0; 
                            padding: 0;
                            width: 58mm; /* Coba paksakan lebar kertas */
                        }
                        pre { 
                            margin: 0; 
                            padding: 0; 
                            font-family: 'monospace'; 
                            font-size: 10pt;
                            word-wrap: break-word; /* Jaga-jaga */
                        }
                        /* Sembunyikan header/footer default browser saat print */
                        @page { margin: 0; } 
                    </style>
                </head>
                <body>
                    <pre>${receiptText}</pre>
                </body>
                </html>
            `);
            doc.close();

            // Beri waktu 500ms agar iframe selesai render sebelum print
            setTimeout(() => {
                try {
                    iframe.contentWindow.focus(); // Fokus ke iframe
                    iframe.contentWindow.print(); // Buka dialog cetak
                } catch (e) {
                    console.error("Gagal print:", e);
                    showNotification("Gagal membuka dialog cetak.", true);
                }
                
                // Bersihkan iframe setelah 2 detik
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 2000);
            }, 500);
        }
        // [--- AKHIR FUNGSI BARU ---]

        // --- LISTENER BARU UNTUK TOMBOL TOGGLE MENU ---
        function setupMenuActionListeners() {
            // Cek agar listener tidak terpasang dua kali
            if (document.body.dataset.menuActionListenerAttached) return;
            document.body.dataset.menuActionListenerAttached = 'true';

            document.body.addEventListener('click', async function(e) {
                // Cari tombol toggle yang diklik
                const toggleBtn = e.target.closest('.toggle-btn[data-action="toggle-availability"]');
                if (!toggleBtn) return;

                const itemId = toggleBtn.dataset.id;
                const itemName = toggleBtn.dataset.name;
                // Ambil status saat ini (string 'true'/'false') dan ubah jadi boolean
                const currentStatus = toggleBtn.dataset.currentStatus === 'true';
                const newStatus = !currentStatus; // Balikkan statusnya

                // PERBAIKAN: Mengganti 'menuItems' ke 'menu' agar sesuai dengan database Anda
                const itemRef = doc(db, 'menu', itemId);
                
                // Matikan tombol sementara proses
                toggleBtn.disabled = true;
                toggleBtn.textContent = 'Menyimpan...';

                try {
                    // Update field 'isAvailable' di Firestore
                    await updateDoc(itemRef, { isAvailable: newStatus });
                    
                    // onSnapshot akan otomatis memperbarui tampilan tombol
                    showNotification(`Status ${itemName} diubah ke ${newStatus ? 'Tersedia' : 'Habis'}.`);
                } catch (error) {
                    console.error("Gagal update status menu:", error);
                    showNotification("Gagal mengubah status.", true);
                    // Jika gagal, kembalikan tombol ke status semula
                    toggleBtn.disabled = false;
                    toggleBtn.textContent = currentStatus ? 'Tersedia' : 'Habis';
                }
            });
        }
        // --- AKHIR LISTENER BARU ---
        
        function setupNavigation() {
             if (document.body.dataset.navListenerAttached) return;
             document.body.dataset.navListenerAttached = 'true';
             const navLinks = document.querySelectorAll('.nav-link');
             const pages = document.querySelectorAll('.page');
             navLinks.forEach(link => {
                 link.addEventListener('click', function(e) {
                     e.preventDefault();
                     const target = this.dataset.page;
                     navLinks.forEach(l => l.classList.remove('active'));
                     this.classList.add('active');
                     pages.forEach(p => p.classList.remove('active'));
                     document.getElementById(`${target}-page`).classList.add('active');
                 });
             });
        }

        function showNotification(message, isError = false) {
            const el = document.createElement('div');
            el.className = 'notification'; el.textContent = message;
            if (isError) el.style.backgroundColor = '#A52A2A';
            document.body.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 3000);
        }
        
        function setupReportDownloader() {
            const downloadBtn = document.getElementById('download-report-btn');
            if (!downloadBtn || downloadBtn.dataset.listenerAttached) return;
            downloadBtn.dataset.listenerAttached = 'true';

            downloadBtn.addEventListener('click', async () => {
                const startDateEl = document.getElementById('start-date');
                const endDateEl = document.getElementById('end-date');

                if (!startDateEl.value || !endDateEl.value) {
                    showNotification("Silakan pilih rentang tanggal terlebih dahulu.", true);
                    return;
                }
                
                downloadBtn.textContent = "Memproses...";
                downloadBtn.disabled = true;

                try {
                    const start = new Date(startDateEl.value);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(endDateEl.value);
                    end.setHours(23, 59, 59, 999);

                    const q = query(
                        collection(db, "completedOrders"),
                        where("completedAt", ">=", Timestamp.fromDate(start)),
                        where("completedAt", "<=", Timestamp.fromDate(end))
                    );

                    const querySnapshot = await getDocs(q);
                    const reportData = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                    if (reportData.length === 0) {
                        showNotification("Tidak ada data penjualan pada periode ini.", true);
                        return;
                    }
                    
                    const headers = ["ID Pesanan", "Tanggal Selesai", "Waktu Selesai", "Nama Pelanggan", "No. Meja", "Item Dipesan", "Subtotal", "Pajak (10%)", "Grand Total", "Metode Bayar"];
                    const csvRows = [headers.join(',')];
                    
                    reportData.sort((a, b) => a.completedAt.seconds - b.completedAt.seconds);

                    for (const order of reportData) {
                        const date = new Date(order.completedAt.seconds * 1000);
                        // Perbaikan: Ambil ID dari 'order.id' yang kita map sebelumnya
                        const orderId = order.id.substring(0, 6); 
                        const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const formattedTime = date.toLocaleTimeString('id-ID');
                        const customer = `"${order.customer}"`;
                        const table = order.table;
                        // MODIFIKASI: Tambahkan varian ke dalam laporan CSV
                        const items = `"${order.items.map(i => 
                            `${i.name}${i.variant ? ` (${i.variant})` : ''} x${i.qty}`
                        ).join('; ')}"`;
                        const subtotal = order.subtotal !== undefined ? order.subtotal : "N/A";
                        const tax = order.tax !== undefined ? order.tax : "N/A";
                        const grandTotal = order.total;
                        const payment = `"${order.paymentMethod}"`;
                        csvRows.push([orderId, formattedDate, formattedTime, customer, table, items, subtotal, tax, grandTotal, payment].join(','));
                    }

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    const fileName = `Laporan_Payboss_${startDateEl.value}_sampai_${endDateEl.value}.csv`;
                    link.setAttribute("download", fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification("Laporan berhasil di-download.");

                } catch (error) {
                    console.error("Error downloading report:", error);
                    showNotification("Gagal men-download laporan.", true);
                } finally {
                    downloadBtn.textContent = "Download Laporan (Excel)";
                    downloadBtn.disabled = false;
                }
            });
        }

    </script>
</body>
</html>
